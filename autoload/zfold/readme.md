# 手动折叠扩展

基本 manual 的折叠模式，使用脚本简化手动折叠的操作，支持正则表达式。

默认定义映射与命令如下，键名与命令名可自行修改：
```vim
nnoremap <Space> :call zfold#cmd#nFold()<CR>
vnoremap <Space> :call zfold#cmd#vFold()<CR>
command -range -nargs=? -bang Z <line1>,<line2>call zfold#cmd#Fold(<bang>0, <f-args>)
```

空格用于切换折叠，如果没有折叠则尝试 matchit 插件，类似 zf% 折叠，如果也未能实
现 % 折叠，则使用 zj 跳转到下一个折叠区。

选择模式下空格，类似 zf 创建折叠。

:Z 命令接收一至两个参数，按正则表达式折叠。可能在扫描中创建多个或嵌套的折叠，
每个折叠至少两行。

## 折叠命令参数

```vim
:1,$ Z! /start-regexp/ /end-regexp/
```

用空格分隔两个命令行参数，每个参数首尾的 `//` 可省略。但是第一个参数 `//` 可表
示空字符串参数。

可指定范围行，默认全文件行。在该范围内搜索起始与终止正则表达式创建折叠。

如果命令有 `!` 修饰，在创建折叠前调用 `zE` 删除原来所有折叠，否则新折叠与旧折
叠共存。

```
:1,$ Z /start-regexp/
```

只提供一个起始参数时，将连续匹配该正则参数的行折叠。

```
:1,$ Z // /end-regexp/
```

只提供一个终止参数时，作为反选折叠，将连续不匹配的行折叠。

## 特殊折叠参数

```
:1,$ Z {}
:1,$ Z ()
:1,$ Z []
```

如果只提供一个参数，且是一对括号，则按括号折叠。不过左括号必须在行尾，右括号必
须在行首，忽略行尾或行首的空白。相当自动展成 `{\s*$ ^\s*}` 两个参数。

如果在括号中插入空格如 `{ }` ，则当作正常的两个正则参数，不会自动限制行尾或行
首。

## 本插件扩展主要特点

手动折叠足够灵活，且不像 marker 插入标记会修改源文件。可以充分利用 z 系快捷键
创建、开头、浏览折叠。通过正则参数单次命令创建折叠也便捷，且可以叠加，分步创建
完全不同类型的折叠。

语法折叠 syntax 或表达式折叠 expr ，虽然更自动化，但如果遇到需要微调折叠时很不
方便。

## 已知问题

手动折叠没法保存，始终需要手动执行命令折叠。但是可以在 ftplugin/ 目录中对感兴
趣的文件类型，自动配置调用一系列 :Z 命令进行折叠。

:Z {} 折叠不能达到 C 系列语言语法折叠的效果，没法排除在注释区的 {} 。

## 致谢

zfold 插件名及 `:Z` 命令名，主要是考虑与内置 z 系统的折叠命令相统一。

按正则手动折叠的思想源于
[https://github.com/ZSaberLv0/ZFVimFoldBloc](https://github.com/ZSaberLv0/ZFVimFoldBloc)
的启发。
